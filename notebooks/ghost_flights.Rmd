---
title: "Ghost Flights -- pilot"
author: "Aine Fairbrother-Browne"
date: "03/22"
output: 
  html_document:
    theme: paper
    highlight: kate
    df_print: paged
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: false  
    fig_caption: true
---

# Introduction  

What is your novel idea?
Why should we care?
How are you going to prove your point?

* Outline environmental problem posed by ghost flights or semi-full flights  
* Difficulty of obtaining ghost flight data - as highlighted by the recent Guardian article/ episode of Guardian In Focus with investigative journalism  
* Is it possible to detect ghost flights from bulk, summarised CAA data  
* This can tell us about airline activities and allow us to scrutinise their practices without having to jump through the loopholes posed by obtaining this kind of data  

3 scenarios: 

* When were the slot rules in place? use it or loose it - https://www.routesonline.com/news/29/breaking-news/297416/uk-increases-minimum-slot-usage-threshold-for-summer-2022/  
* pre pandemic = 80%  
* summer 2020 - summer 2021 = 0%  
* winter 2021/22 = 50%
* March 27/03/22 = 70%


```{r setup, include=FALSE}

# import libs
library(tidyverse)
library(DT)
library(ggforce)

knitr::opts_chunk$set()
knitr::opts_knit$set(root.dir = "~/Documents/PhD/r_projects/ghost_flights/")

```

# Obtain data  

* I downloaded 2021 UK airline activity data from [here](https://www.caa.co.uk/data-and-analysis/uk-aviation-market/airlines/uk-airline-data/uk-airline-data-2021/)  
* It is divided up by month, and each monthly dataset must be downloaded separately  
* For the pilot study, I downloaded the following table: "Table 03 - All Services", using the command `wget -c https://www.caa.co.uk/Documents/Download/8634/87542ebf-3d02-44c1-8650-d8dbd6eca742/2863 -O dec_21_all_services.csv;`  
* The inclusion criteria as per CAA for airlines and passengers contained in their data is as follows:  
* Airlines: "Airlines with an aircraft having a Maximum Take Off Mass (MTOM) above 40 tonnes and/or an A type Operating licence or Air Transport Licence are required, under Section 84 (1) of the Civil Aviation Act 1982, to report regular monthly data. However, charter services performed by aircraft below 15 tonnes MTOM and sole use/exempt in type are not included in published tables."  
* Passengers: "Recorded as 'uplifted passengers', they cover passengers carried by the airlines worldwide, not only to/from the UK, and relate to passengers who have paid the equivalent of 25% of the normal fare. Note that infants under 2 years are not included."  

```{bash eval=F, include=F}

cd /Users/ainefairbrother/Documents/PhD/r_projects/ghost_flights/data

# pre pandemic, non christmas - 80%
wget -c https://www.caa.co.uk/Documents/Download/4032/36ea4cce-bc59-4e62-9aad-32bfcc0e0a9e/1809 -O nov_19_all_services.csv;

# summer 2020 - 0%
wget -c https://www.caa.co.uk/Documents/Download/4128/26d80e8a-1719-4c7c-9a24-4b16a848c0b4/1929 -O jul_20_all_services.csv;

# winter 2022 - 50% 
wget -c https://www.caa.co.uk/Documents/Download/9085/957ac730-2947-4be0-b029-3191e6fb2a3e/2935 -O jan_22_all_services.csv;


wget -c https://www.caa.co.uk/Documents/Download/8634/87542ebf-3d02-44c1-8650-d8dbd6eca742/2863 -O dec_21_all_services.csv;
wget -c https://www.caa.co.uk/Documents/Download/4023/fe48c60b-e232-4390-b9de-a51ab6d29c8f/1716 -O dec_19_all_services.csv;

```

* Read in downloaded data  

```{r message=FALSE, warning=FALSE}

dec21.allservices = readr::read_csv("./data/jan_22_all_services.csv")

```

* A quick preview of the data structure  

```{r paged.print=TRUE}

dec21.allservices %>% 
  DT::datatable(., 
                extensions = 'FixedColumns',
                options = list(
                  dom = 't',
                  scrollX = TRUE,
                  scrollCollapse = TRUE
                ))

```

# Filter data  

* We will filter for only passenger services, as this is the focus of the project  
* Also filter out airlines that carried 0 passengers - we will come back to these

```{r}

dec21.allservices = dec21.allservices %>% 
  dplyr::filter(type_of_operations=="Passenger") %>% 
  dplyr::filter(total_passengers_uplifted>0)

```

# Understanding the data  

```{r}

dec21.allservices %>% 
  colnames()

```

* These bulk data summarise all of the flights run by UK airlines in a given time period  
* Let's take a look at the columns of interest included in this data and understand them  
* Sources: [airlinegeeks.com](https://airlinegeeks.com/2015/12/28/airline-metrics-available-seat-kilometers/), [caa.co.uk](https://www.caa.co.uk/data-and-analysis/uk-aviation-market/airlines/notes-and-faqs/), [ir.aeroflot.com](https://ir.aeroflot.com/fileadmin/user_upload/files/eng/glossary_eng.pdf)  

1. `seat_km_available_x1000`  
+ The available seat kilometer is a measure of passenger carrying capacity of an airline (in kilometers)  
+ It is calculated by multiplying the available seats on any given aircraft by the number of kilometres flown on a given flight
+ So the 'seat kilometer available' is a measure of the total flight passenger capacity  
+ The number is given divided by 1000 as indicated by the column name, so multiply it by 1000 to get true value  
+ `seat_km_available_x1000` = (total number of seats available for scheduled passengers)*(total number of kilometers in which those seats were flown)  
2. `seat_km_used_x1000`  
+ Using the above information about the 'seat kilometer available' metric, we can assume that: 
+ `seat_km_used_x1000` = (total number of seats used for scheduled passengers)*(total number of kilometers in which those seats were flown)  

* These seat-kilometer values are useful, as they allow direct comparison between airlines  
* They account for different fleet composition between airlines, for example  

# Calculating variables  
    
* It's useful to understand what proportion of seat-kilometers were used as opposed to not, so:  

```{r}

dec21.allservices = dec21.allservices %>% 
  dplyr::mutate(
    
    # get raw values for those that are divided by 1000
    seat_km_available = seat_km_available_x1000*1000,
    seat_km_used = seat_km_used_x1000*1000,
    aircraft_km = aircraft_km_x1000*1000,
    
    # calculate used as a % of avail, and % unused
    seat_km_used_as_percent_of_avail = (seat_km_used/seat_km_available)*100,
    seat_km_unused_as_percent_of_avail = 100-seat_km_used_as_percent_of_avail,
    
    # calculate average passengers per flight
    avg_passengers_per_flight=total_passengers_uplifted/no_flights
    
  ) %>% 
  
  # remove redundant cols
  dplyr::select(-contains("x1000"))

```

# Visualising the data

## First, how do airlines compare?  

* Plot the `seat_km_available` against `seat_km_used` to reveal the extent to which airlines fall short of filling their available seat kilometers  
* Sitting on the diagonal line would mean that an airline had filled all of its seats  

* Define colour palette - let's use this one, courtesy of [designpieces](https://www.designpieces.com/palette/british-airways-color-palette-hex-and-rgb/)

```{r}

ba.cols = c("#075aaa","#eb2226","#01295c","#efe9e5","#aca095","#b9cfed","#a7a9ac")

```

```{r, fig.height=3.5, fig.width=5, fig.cap=""}

avg.line = dec21.allservices$seat_km_unused_as_percent_of_avail %>% mean()

p1 = dec21.allservices %>% 
  
  ggplot(data=., aes(x=reorder(airline_name, seat_km_unused_as_percent_of_avail), y=seat_km_unused_as_percent_of_avail)) + 
  theme_bw(base_size=12) +
  geom_hline(yintercept=avg.line, colour="grey", alpha=0.75)  +
  geom_point(aes(size=total_passengers_uplifted, colour=no_flights)) +

  theme(
    legend.position=c(0.17, 0.78),
    plot.title = element_text(hjust=0.5),
    legend.key.size = unit(0.8,"line"),
    # legend.text = element_text(size=12),
    # legend.title = element_text(size=12),
    legend.background = element_blank(),
    axis.text.x = element_text(angle=55, size=8, hjust=1),
    legend.direction = "vertical", 
    legend.box = "horizontal"
  ) + 
  labs(color="Total no. of flights", size="Total no. of passengers", title="\nDot plot to show seat km usage (as % of avaialable) of 28 UK airlines\n") +
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
  scale_colour_gradient(high=ba.cols[2], low=ba.cols[1], guide = "colourbar") +
  scale_size_continuous(breaks=c(50, 500, 5000, 50000, 500000, 1500000), labels=c("50", "500", "5000", "50000", "500000", "1500000"), guide="legend") +
  ylab("\nSeat km unused as % of available\n") +
  xlab("Airline") + 
  scale_y_continuous(breaks = seq(0, 100, by=10), limits=c(0,100)) 

p1

```
* The average % seat km unused sits at 52%  
* This means that on average, 52.8% of plane capacity is being left empty  
* In terms of airlines, the plot highlights particular airlines that run the most flights (red) and carry the most passengers (large dot)  
* So let's look at these airlines in particular, as their market share indicates that should be leading the way in terms of climate responsibility  
* This plot clearly shows that in December 2021, EasyJet was the largest airline (in terms of passengers and flights) who vastly underutilised it's seat km capacity (48% unused)
* EasyJet underutilises capacity more than average, and also much more than the British Airways (30.5% unused), a comparably large airline  
* Others such as TUI, Jet2, Virgin Atalantic Airways also hold large market shares and underuse their capacity  

# Could any of these flights be ghost flights?  

* Is it possible that any of these are empty?  
* Hard to tell because of the summary-level data that's available  
* But we can have a look at the average data, and make assessments from this  
* So let's compare average passengers per flight with the capacity of 3 aircraft that make up the majority of UK airline fleets  
* Source: https://www.statista.com/statistics/304077/aircraft-types-in-use-in-the-uk-united-kingdom/
* The Airbus A320, the Airbus 319 and the Boeing 737-800 are the top 3 leading models of aircraft in use in the United Kingdom (CAA data, UK, 2020), where the Airbus A320 has the most vehicles in service at 187, the Airbus A319 has 120 and the Boeing 737-800 has 103  
* Let's look at airlines for which these models are the largest constituents of their fleets  

I obtained the following information from the respective airline websites:  

| Airline             | Most common plane model in fleet |
| ------------------- | -------------------------------- |
| AER LINGUS (UK) LTD | Airbus A320                      |
| BRITISH AIRWAYS PLC | Airbus A320                      |
| EASYJET UK LTD      | Airbus A320                      |
| JET2.COM LTD        | Boeing 737-800                   |
| RYANAIR UK LTD      | Boeing 737-800                   |
| WIZZ AIR UK LTD     | Airbus A320                      |
| TUI AIRWAYS LTD     | Boeing 737-800                   |  

* This will allow us to get a more accurate picture of plane capacity, and to get closer to understanding how many of these flights might be empty or ultra-low capacity   

```{r, fig.height=3.5, fig.width=5, fig.cap=""}

# https://aircraft.airbus.com/en/aircraft/a320/a320ceo#:~:text=With%20a%20versatile%20cabin%20that,relax%20and%20enjoy%20the%20flight.
airbus.a320.max.capacity = 180 
Boeing.737800.max.capacity = 189

p2 = dec21.allservices %>% 
  dplyr::mutate(avg_passengers_per_flight=total_passengers_uplifted/no_flights) %>% 
  dplyr::select(airline_name, avg_passengers_per_flight) %>% 
  dplyr::filter(airline_name %in% c("AER LINGUS (UK) LTD", "BRITISH AIRWAYS PLC", "EASYJET UK LTD", "JET2.COM LTD", "RYANAIR UK LTD", "TUI AIRWAYS LTD", "WIZZ AIR UK LTD")) %>% 
  
  ggplot(data=., aes(x=reorder(airline_name, avg_passengers_per_flight), y=avg_passengers_per_flight)) + 
  theme_bw(base_size=12) +
  geom_col(fill=ba.cols[1]) +
  theme(axis.text.x = element_text(angle=45, size=8, hjust=1),
        plot.title = element_text(hjust = 0.5)
  ) + 
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
  ylab("\nAverage no. passengers per flight\n ") + 
  xlab("Airline") +
  labs(title="") + 
  geom_hline(yintercept=airbus.a320.max.capacity, alpha=0.5) +
  geom_text(aes(x=0, y=airbus.a320.max.capacity, label = "Airbus A320 max. capacity", vjust = 1.5, hjust=-0.1), fontface="plain", size=3, check_overlap=T) +
  geom_hline(yintercept=Boeing.737800.max.capacity, alpha=0.5) +
  geom_text(aes(x=0, y=Boeing.737800.max.capacity, label = "Boeing 737-800 max. capacity", vjust = 1.5, hjust=-0.09), fontface="plain", size=3, check_overlap=T) +
  scale_y_continuous(breaks = seq(0, 200, by=10)) 

p2

```
* So for the airlines that have A320s and 737-800s as their main fleet members, it is clear to see that the average number of passengers on a flight falls well below the maximum capacity of these models  
* Clearly it is impossible to tell from this data alone how many flights exactly are running empty, or at extremely low capacity  
* But this does suggest that this may be one of a few potential scenarios at play here  
* Perhaps all flights are flying at slightly below capacity  
* Perhaps some flights are full and a proportion of flights are flying drastically below capacity  
* Or perhaps most are full, and a proportion of flights are empty or near-empty AKA, ghost flights  
* In any case, this under-use of capacity is extraordinarily wasteful  
* And what we can tell from this data is that, on average, across the 28 UK airlines that we have data for, 52% of the available passenger capacity was unused in December 2021  

# Conclusions  

* The main issue with this data, is that there is no per-flight breakdown, this is an average over all of the flights in the period  
* We cannot discern from this data the distribution of un-used seats across flights    
* This is largely driven by the airport slot rule: https://www.airport-technology.com/news/uk-extends-slot-rules/#:~:text=Under%20the%20new%20rule%2C%20airlines,return%20to%20pre%2Dpandemic%20levels.











```{r, fig.height=5, fig.width=8, fig.cap=""}

# avg.line = dec21.allservices$seat_km_unused_as_percent_of_avail %>% mean()
# 
# p2 = dec21.allservices %>% 
#   
#   dplyr::select(airline_name, seat_km_used_as_percent_of_avail, seat_km_unused_as_percent_of_avail) %>% 
#   dplyr::mutate(plot.order = seat_km_unused_as_percent_of_avail) %>% 
#   tidyr::pivot_longer(., 2:3, names_to="seats", values_to="percent") %>% 
#   
#   ggplot(data=., aes(x=reorder(airline_name, plot.order), y=percent, fill=seats)) + 
#   theme_bw(base_size=9) +
#   geom_bar(position="stack", stat="identity") + 
#   theme(axis.text.x = element_text(angle=45, size=5, hjust=1),
#         plot.title = element_text(hjust = 0.5)
#   ) + 
#   scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
#   ylab("%") + 
#   xlab("Airline") +
#   ylim(0,100) +
#   labs(title="\nBarplot to show the % unused seats per airline for 28 UK airlines.\n The horizontal line denotes the average seat km unused\n", fill="Seat km") +
#   geom_hline(yintercept=avg.line, colour=ba.cols[6])  +
#   scale_fill_manual(values=c(ba.cols[2], ba.cols[1]), labels = c("Not used", "Used"))
# 
# p2

```



