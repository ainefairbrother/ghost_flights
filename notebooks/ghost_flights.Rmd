---
title: "Ghost Flights -- pilot"
author: "Aine Fairbrother-Browne"
date: "03/22"
output: 
  html_document:
    theme: paper
    highlight: kate
    df_print: paged
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: false  
    fig_caption: true
---

# Introduction  

What is your novel idea?
Why should we care?
How are you going to prove your point?

* Outline environmental problem posed by ghost flights or semi-full flights  
* Difficulty of obtaining ghost flight data - as highlighted by the recent Guardian article/ episode of Guardian In Focus with investigative journalism  
* Is it possible to detect ghost flights from bulk, summarised CAA data  
* This can tell us about airline activities and allow us to scrutinise their practices without having to jump through the loopholes posed by obtaining this kind of (seemingly secret!) data  

```{r setup, include=FALSE}

# import libs
library(tidyverse)
library(DT)
library(ggforce)

knitr::opts_chunk$set()
knitr::opts_knit$set(root.dir = "~/Documents/PhD/r_projects/ghost_flights/")

```

# Obtain data  

* I downloaded 2021 UK airline activity data from [here](https://www.caa.co.uk/data-and-analysis/uk-aviation-market/airlines/uk-airline-data/uk-airline-data-2021/)  
* It is divided up by month, and each monthly dataset must be downloaded separately  
* For the pilot study, I downloaded the following table: "Table 03 - All Services", using the command `wget -c https://www.caa.co.uk/Documents/Download/8634/87542ebf-3d02-44c1-8650-d8dbd6eca742/2863 -O dec_21_all_services.csv;`  
* The inclusion criteria as per CAA for airlines and passengers contained in their data is as follows:  
* Airlines: "Airlines with an aircraft having a Maximum Take Off Mass (MTOM) above 40 tonnes and/or an A type Operating licence or Air Transport Licence are required, under Section 84 (1) of the Civil Aviation Act 1982, to report regular monthly data. However, charter services performed by aircraft below 15 tonnes MTOM and sole use/exempt in type are not included in published tables."  
* Passengers: "Recorded as 'uplifted passengers', they cover passengers carried by the airlines worldwide, not only to/from the UK, and relate to passengers who have paid the equivalent of 25% of the normal fare. Note that infants under 2 years are not included."  

```{bash eval=F, include=F}

cd /Users/ainefairbrother/Documents/PhD/r_projects/ghost_flights/data
wget -c https://www.caa.co.uk/Documents/Download/8634/87542ebf-3d02-44c1-8650-d8dbd6eca742/2863 -O dec_21_all_services.csv;

```

* Read in downloaded data  

```{r message=FALSE, warning=FALSE}

dec21.allservices = readr::read_csv("./data/dec_21_all_services.csv")

```

* A quick preview of the data structure  

```{r paged.print=TRUE}

dec21.allservices %>% 
  DT::datatable(., 
                extensions = 'FixedColumns',
                options = list(
                  dom = 't',
                  scrollX = TRUE,
                  scrollCollapse = TRUE
                ))

```

# Filter data  

* We will filter for only passenger services, as this is the focus of the project  

```{r}

dec21.allservices = dec21.allservices %>% 
  dplyr::filter(type_of_operations=="Passenger")

```

# Understanding the data  

```{r}

dec21.allservices %>% 
  colnames()

```

* These bulk data summarise all of the flights run by UK airlines in a given time period  
* Let's take a look at the columns of interest included in this data and understand them  
* Sources: [airlinegeeks.com](https://airlinegeeks.com/2015/12/28/airline-metrics-available-seat-kilometers/), [caa.co.uk](https://www.caa.co.uk/data-and-analysis/uk-aviation-market/airlines/notes-and-faqs/), [ir.aeroflot.com](https://ir.aeroflot.com/fileadmin/user_upload/files/eng/glossary_eng.pdf)  

1. `seat_km_available_x1000`  
+ The available seat kilometer is a measure of passenger carrying capacity of an airline (in kilometers)  
+ It is calculated by multiplying the available seats on any given aircraft by the number of kilometres flown on a given flight
+ So the 'seat kilometer available' is a measure of the total flight passenger capacity  
+ The number is given divided by 1000 as indicated by the column name, so multiply it by 1000 to get true value  
+ `seat_km_available_x1000` = (total number of seats available for scheduled passengers)*(total number of kilometers in which those seats were flown)  
2. `seat_km_used_x1000`  
+ Using the above information about the 'seat kilometer available' metric, we can assume that: 
+ `seat_km_used_x1000` = (total number of seats used for scheduled passengers)*(total number of kilometers in which those seats were flown)  

* These seat-kilometer values are useful, as they allow direct comparison between airlines  
* They account for different fleet composition between airlines, for example  

# Calculating useful variables  
    
* Then it would be useful to understand what proportion of seat-kilometers were used as opposed to not, so:  

```{r}

dec21.allservices = dec21.allservices %>% 
  dplyr::mutate(
    
    # get raw values for those that are divided by 1000
    seat_km_available = seat_km_available_x1000*1000,
    seat_km_used = seat_km_used_x1000*1000,
    aircraft_km = aircraft_km_x1000*1000,
    
    # calculate used as a % of avail, and % unused
    seat_km_used_as_percent_of_avail = (seat_km_used/seat_km_available)*100,
    seat_km_unused_as_percent_of_avail = 100-seat_km_used_as_percent_of_avail
    
  ) %>% 
  
  # remove redundant cols
  dplyr::select(-contains("x1000"))

```

* Plot the `seat_km_available` against `seat_km_used` to reveal the extent to which airlines fall short of filling their available seat kilometers  
* Sitting on the diagonal line would mean that an airline had filled all of its seats 

```{r, fig.height=6, fig.width=9, fig.cap=""}

max.seat.km.avail = dec21.allservices$seat_km_available %>% max()

p1 = dec21.allservices %>% 
  dplyr::filter(no_flights>500) %>% # remove some of the smaller from plot
  
  ggplot(data=., aes(x=seat_km_available, y=seat_km_used, label=airline_name)) + 
  theme_bw(base_size=12) +
  geom_point(size=0) + 
  geom_abline(intercept = 0, slope = 1) +
  geom_label(size=2, alpha=0.7, position=position_jitter()) +
  xlim(0,max.seat.km.avail+10000) +
  ylim(0,max.seat.km.avail+10000)

p1 

```

# Visualising the results  

* Define colour palette - let's use BA's colours, courtesy of [designpieces](https://www.designpieces.com/palette/british-airways-color-palette-hex-and-rgb/)

```{r}

ba.cols = c("#075aaa","#eb2226","#01295c","#efe9e5","#aca095","#b9cfed","#a7a9ac")

```

```{r, fig.height=5, fig.width=8, fig.cap="Barplot to show the % unused seats per airline. Data is from December 2021, and 28 UK airlines have been included. The horizontal line denotes the average % of seats"}

avg.line = dec21.allservices$seat_km_unused_as_percent_of_avail %>% mean()

p2 = dec21.allservices %>% 
  
  dplyr::select(airline_name, seat_km_used_as_percent_of_avail, seat_km_unused_as_percent_of_avail) %>% 
  dplyr::mutate(plot.order = seat_km_unused_as_percent_of_avail) %>% 
  tidyr::pivot_longer(., 2:3, names_to="seats", values_to="percent") %>% 
  
  ggplot(data=., aes(x=reorder(airline_name, plot.order), y=percent, fill=seats)) + 
  theme_bw(base_size=9) +
  geom_bar(position="stack", stat="identity") + 
  theme(axis.text.x = element_text(angle=45, size=5, hjust=1),
        plot.title = element_text(hjust = 0.5)
  ) + 
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
  ylab("% of seats") + 
  xlab("Airline") +
  ylim(0,100) +
  labs(title="% of seats unused in December for the passenger \n services of 28 UK airlines in December 2021") +
  geom_hline(yintercept=avg.line, colour=ba.cols[6])  +
  scale_fill_manual(values=c(ba.cols[2], ba.cols[1]), labels = c("Empty", "Not empty"))

p2

```

# Could any of these flights be ghost flights?  

* Is it possible that any of these are empty?
* Hard to tell because of the summary-level data  

```{r, fig.height=6, fig.width=9, fig.cap=""}

# https://aircraft.airbus.com/en/aircraft/a320/a320ceo#:~:text=With%20a%20versatile%20cabin%20that,relax%20and%20enjoy%20the%20flight.
airbus.a320.max.capacity = 180
Boeing.737800.capacity = 189

dec21.allservices %>% 
  dplyr::mutate(avg_passengers_per_flight=total_passengers_uplifted/no_flights) %>% 
  dplyr::select(airline_name, avg_passengers_per_flight) %>% 
  
  ggplot(data=., aes(x=reorder(airline_name, avg_passengers_per_flight), y=avg_passengers_per_flight)) + 
  theme_bw(base_size=9) +
  geom_col() +
  theme(axis.text.x = element_text(angle=45, size=5, hjust=1),
        plot.title = element_text(hjust = 0.5)
  ) + 
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
  ylab("Average passengers per flight") + 
  xlab("Airline") +
  labs(title="") + 
  geom_hline(yintercept=airbus.a320.max.capacity, alpha=0.5) + 
  geom_text(aes(0,airbus.a320.max.capacity,label = "Airbus A320 max. capacity", vjust = 1.5, hjust=-0.1), size=3) +
  geom_hline(yintercept=Boeing.737800.capacity, alpha=0.5) + 
  geom_text(aes(0,Boeing.737800.capacity,label = "Boeing 737-800 max. capacity", vjust = 1.5, hjust=-0.1), size=3)

```


# Conclusions  

* The main issue with this data, is that there is no per-flight breakdown, this is an average over all of the flights in the period  
* We cannot discern from this data the distribution of un-used seats - i.e. how many planes fly empty vs. how many fly 50% empty etc.  
* Some (hardly any) might be passengers <2, but the majority will be on laps anyway  













